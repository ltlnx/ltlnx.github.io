<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Solve Suspend Issues in Certain Macbooks</title>
        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" type="text/css" href="https://ltlnx.github.io/style.css">
        <link rel="icon" href="data:,">
        <link rel="alternate" type="application/rss+xml" title="All Pages on the Website" href="https://ltlnx.github.io/rssfeed.xml">
    </head>
    <body>
        <div id='sbl'>
            <h3>Sidebar</h3>
            <ul>
                <li><a href='https://ltlnx.github.io/index.html'>Home</a></li>
                <li><a href='https://ltlnx.github.io/others/links.html'>Links</a></li>
                <li><a href='https://ltlnx.github.io/blerbs/index.html'>Blerbs</a></li>
                <li><a href='https://ltlnx.github.io/others/about.html'>About</a></li>
                <li><a href='https://ltlnx.github.io/others/rss.html'>RSS</a></li>
                <li><a href='https://g0v.social/@ltlnx'>Mastodon</a></li>
            </ul>
        </div>
<div class="nav">
<p><a href="../index.html">ltlnx</a> &gt; <a
href="index.html">Slackware</a> &gt;</p>
</div>
<main>
<h1 id="solve-suspend-issues-in-certain-macbooks">Solve Suspend Issues
<br class="wb">in Certain Macbooks</h1>
<p><em>This was posted by me on the <a
href="https://www.linuxquestions.org/questions/slackware-14/solve-suspend-issues-in-certain-macbooks-4175720478/">Slackware
forum</a> on January 2023.</em></p>
<p>After some extensive troubleshooting I finally solved my
long-standing suspend problem, so I’m keeping this here for reference
(and for people who are in the same situation).</p>
<p>The problem goes as follows: starting from kernel version 5.15, my
Macbook Pro (model A1398) wouldn’t wake up from suspend. Running tools
like Intel’s <a href="https://github.com/intel/pm-graph">pm-graph</a>
didn’t yield anything interesting. So I switched the lid close action to
hibernate and ignored the problem.</p>
<p>A few days ago I picked up the problem again and looked at various
logs. dmesg didn’t contain anything other than a jump in time between
log entries, but the syslog had something like this:</p>
<pre><code>Jan  4 05:04:51 dankstar kernel: thunderbolt 0000:07:00.0: device link creation from 0000:06:00.0 failed
Jan  4 05:04:52 dankstar kernel: ACPI Warning: SystemIO range 0x0000000000000840-0x000000000000084F conflicts with OpRegion 0x0000000000000800-0x0000000000000863 (\x5cGPIO) (20220331/utaddress-204)
Jan  4 05:04:52 dankstar kernel: ACPI Warning: SystemIO range 0x0000000000000830-0x000000000000083F conflicts with OpRegion 0x0000000000000800-0x0000000000000863 (\x5cGPIO) (20220331/utaddress-204)
Jan  4 05:04:52 dankstar kernel: ACPI Warning: SystemIO range 0x0000000000000800-0x000000000000082F conflicts with OpRegion 0x0000000000000800-0x0000000000000863 (\x5cGPIO) (20220331/utaddress-204)
Jan  4 05:04:52 dankstar kernel: ACPI Warning: SystemIO range 0x0000000000000800-0x000000000000082F conflicts with OpRegion 0x0000000000000810-0x0000000000000813 (\x5cIO_D) (20220331/utaddress-204)
Jan  4 05:04:52 dankstar kernel: ACPI Warning: SystemIO range 0x0000000000000800-0x000000000000082F conflicts with OpRegion 0x0000000000000800-0x000000000000080F (\x5cIO_T) (20220331/utaddress-204)
Jan  4 05:04:52 dankstar kernel: lpc_ich: Resource conflict(s) found affecting gpio_ich
Jan  4 05:04:52 dankstar kernel: wl: loading out-of-tree module taints kernel.
Jan  4 05:04:52 dankstar kernel: wl: module license &#39;MIXED/Proprietary&#39; taints kernel.
Jan  4 05:04:52 dankstar kernel: Disabling lock debugging due to kernel taint
Jan  4 05:04:52 dankstar kernel: eth0: Broadcom BCM43a0 802.11 Hybrid Wireless Controller 6.30.223.271 (r587334)
Jan  4 05:04:52 dankstar kernel: 
Jan  4 05:04:52 dankstar kernel: applesmc applesmc.768: hwmon_device_register() is deprecated. Please convert the driver to use hwmon_device_register_with_info().
Jan  4 05:04:52 dankstar udevd[765]:  Unable to EVIOCGABS device &quot;/dev/input/event10&quot;
Jan  4 05:04:52 dankstar last message buffered 3 times
Jan  4 05:04:55 dankstar kernel: FAT-fs (sda1): Volume was not properly unmounted. Some data may be corrupt. Please run fsck.
Jan  4 05:04:58 dankstar udevd[760]:  Unable to EVIOCGABS device &quot;/dev/input/event10&quot;
Jan  4 05:04:58 dankstar last message buffered 3 times
Jan  4 05:05:04 dankstar udevd[751]:  specified group &#39;adbusers&#39; unknown
Jan  4 05:05:05 dankstar bluetoothd[1685]: profiles/audio/vcp.c:vcp_init() D-Bus experimental not enabled
Jan  4 05:05:05 dankstar bluetoothd[1685]: src/plugin.c:plugin_init() Failed to init vcp plugin
Jan  4 05:05:05 dankstar bluetoothd[1685]: profiles/audio/mcp.c:mcp_init() D-Bus experimental not enabled
Jan  4 05:05:05 dankstar bluetoothd[1685]: src/plugin.c:plugin_init() Failed to init mcp plugin
Jan  4 05:05:05 dankstar bluetoothd[1685]: profiles/audio/bap.c:bap_init() D-Bus experimental not enabled
Jan  4 05:05:05 dankstar bluetoothd[1685]: src/plugin.c:plugin_init() Failed to init bap plugin
Jan  4 05:05:05 dankstar bluetoothd[1685]: Failed to set privacy: Rejected (0x0b)
Jan  4 05:05:05 dankstar dnsmasq[1975]: no servers found in /etc/resolv.conf, will retry
Jan  4 05:05:06 dankstar kernel: L1TF CPU bug present and SMT on, data leak possible. See CVE-2018-3646 and https://www.kernel.org/doc/html/latest/admin-guide/hw-vuln/l1tf.html for details.
Jan  4 05:05:06 dankstar kernel: ahci 0000:04:00.0: VPD access failed.  This is likely a firmware bug on this device.  Contact the card vendor for a firmware update</code></pre>
<p>Then there were no further messages until the next force restart. So
I guessed that it was a thunderbolt problem. While searching for more
info I found this blog entry, where someone in the comments say that the
thunderbolt module needs to be disabled before suspend, and reactivated
after resume.</p>
<p>Therefore the solution is to:</p>
<ul>
<li>Add to /lib/elogind/system-sleep (or /lib64/elogind/system-sleep
depending on your architecture) a file named 50-thunderbolt-fix (could
be any name):</li>
</ul>
<pre><code>    #!/bin/sh
    case &quot;${1-}&quot; in
        &#39;pre&#39;)
            exec modprobe -r thunderbolt
            ;;

        &#39;post&#39;)
            exec modprobe thunderbolt
            ;;

        *)
            exit 64
            ;;
    esac</code></pre>
<ul>
<li>Make sure the file is executable (chmod +x 50-thunderbolt-fix).</li>
</ul>
<p>Then you can reboot (or not?) and test if it works. At least it
worked for me :)</p>
<p>ltlnx @ school main library</p>
<p><em>Last updated: 2023-01-04</em></p>
</article>
<div id="footer">
    <p>© ltlnx under <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>. Additional terms in the <a href="https://ltlnx.github.io/others/about.html#copyright">About</a> page.</span>
</div>
</body>
</html>
